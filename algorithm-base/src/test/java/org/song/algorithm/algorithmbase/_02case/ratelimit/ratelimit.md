# 限流算法

> 备注: 不在维护, 内容同步到 算法 项目



> 高并发3大利器: 缓存, 降级, 限流



## 1. 限流常用算法

1. 计数器(固定窗口)算法
2. 滑动窗口算法
3. 漏桶算法
4. 令牌桶算法

```markdown
按时间限流: 限流就是在固定时间范围内限制访问的流量(包括访问次数或者数据量), 有两个的单位, 1是时间, 2是流量单位
此类限流算法或限流工具要围绕者两个变量进行实现

按次数限流: 限制同一时刻最多访问并发数, 用于控制同一资源的访问并发数, 但是由于没有时间单位, 所以单位时间内的并发数是不能控制的, 比如信号量工具
```



### 1. 计数器(固定窗口)算法

```markdown
描述: 一定时间范围内, 记录访问的次数, 超过限流的次数, 及触发限流
优点: 实现简单
缺点: 存在临界值, 当出现时间临界值的情况, 计次就会不准确, 会出现限流次数是n, 实际到达2n才会触发限流, 突刺现象
示例: 使用Redis为例, 
	方式1: 每秒10次QPS, 则访问一次计数器+1, 同时限流缓存超时时间为1s, 访问的时候如果缓存存在且超过次数, 则触发限流
	方式2: 每秒10次QPS, 访问的时候记录缓存时间并初始化次数, 再次访问计数器+1, 同时如果缓存时间超过1s且次数未超过则重置值, 如果缓存时间未超过1s且次数超过, 则触发限流(注意: 该操作不具备原子性)
```



### 2. 滑动窗口算法

```markdown
描述: 和固定窗口类似, 以一个固定的时间段为单位进行访问次数统计, 和固定窗口不同的是, 计次并不是在某些固定的时间点, 而是以当前访问时间为基准, 当前访问时间往前推固定时间范围内, 如果在该范围内的访问次数达到阈值, 则触发限流
优点: 解决了固定窗口的时间临界问题, 能够精确控制访问量
缺点: 无法做到流量整形, 也就是单位时间内的请求仍然是不均匀的, 虽然可以使用更小的单位时间控制能够达到流量整形的效果, 但是不是最终解决方法
示例: 以Redis为例
	1. 使用 zset, 每秒10次QPS, 将访问和时间一一对应, 取当前时间往前1s范围内的访问次数, 如果超出, 则触发限流
```

### 3. 信号量算法

```markdown
描述: 信号量相当于固定数量的锁, 请求通过获取锁来获取访问许可, 信号量的数量是固定的, 也就是可以控制同时并发数, 方访问结束后将持有的信号量释放, 等待的现成可以继续获取锁并进行访问
有点: 能有效解决最大并发数问题, 和时间无关, 只控制同时的并发数
缺点: 没有整流效果, 
示例: 采用JUC的 Semaphore 工具
```


### 3. 漏桶算法

```markdown
描述: 将请求放到一个具有上限容量的桶中, 超出上限, 则触发限流, 该桶以一定速率释放请求, 释放的请求即为请求通过
优点: 能够实现流量整形(Traffic Shaping)和速率限制(Rate Limiting), 和滑动窗口相比, 对流量整形的效果更加明显, 
缺点: 无法应对突发请求, 由于释放请求的速率是固定的, 所以处理请求的速率也是固定的. 在处理请求的时候, 处理的速度要么是0, 要么是限流的速度, 比如: 短时间有突发请求但是下游有处理这样突发请求的能力, 漏桶依然以固定速率释放请求, 就会造成效率低下
```



### 4. 令牌桶算法

```markdown
描述: 以一定的速率(时间/限流值)向令牌桶中增加令牌, 直到令牌桶满, 当请求到达时从桶中获取令牌, 持有令牌的请求可以通过, 当获取不到令牌时, 则触发限流
优点: 能够实现流量整形(Traffic Shaping)和速率限制(Rate Limiting), 相比较于漏桶算法, 能够处理突发请求, 比如: 短时间有突发请求, 如果桶内有足够多令牌, 则释放这些请求交给下游处理, 否则触发限流
示例: guava的RateLimiter

```



| 算法     | 参数                     | 空间复杂度 | 时间复杂度 | 限制突发流量 | 平滑限流         | 分布式实现难度 |
| -------- | ------------------------ | ---------- | ---------- | ------------ | ---------------- | -------------- |
| 固定窗口 | 时间周期, 周期内次数     | O(1)       | O(1)       | 否           | 否               | 低             |
| 滑动窗口 | 时间周期, 周期内次数     | O(n)       | O(n)       | 是           | 中, 根据窗口大小 | 中             |
| 漏桶     | 漏桶流出速度, 漏桶容量   | O(1)       | O(n)       | 是           | 是               | 高             |
| 令牌桶   | 令牌产生速度, 令牌桶容量 | O(1)       | O(n)       | 是           | 是               | 高             |



